<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Products & Services - Moi University Ajira Club</title>
    <!-- Use Tailwind CSS for a modern, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="homepage.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-green-900 text-white py-4">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
           
            <div class="space-x-4">
                <a href="index.html" class="hover:text-green-400">Home</a>
                <a href="post-products.html" class="bg-green-600 px-4 py-2 rounded-md hover:bg-green-700">Post</a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="bg-green-600 text-white py-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <h1 class="text-4xl font-bold mb-4">Browse Products & Services</h1>
            <p class="text-xl mb-6">Discover amazing products and services from our community</p>
            <div class="max-w-md mx-auto">
                <input type="text" id="searchInput" placeholder="Search products or services..." 
                       class="w-full px-4 py-2 rounded-md text-gray-900" onkeypress="if(event.key==='Enter') searchProducts()">
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow p-4 flex flex-wrap gap-4 items-center">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                <select id="typeFilter" class="px-3 py-2 border border-gray-300 rounded-md" onchange="filterProducts()">
                    <option value="">All Types</option>
                    <option value="product">Products</option>
                    <option value="service">Services</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <select id="categoryFilter" class="px-3 py-2 border border-gray-300 rounded-md" onchange="filterProducts()">
                    <option value="">All Categories</option>
                    <option value="Web Development">Web Development</option>
                    <option value="Graphic Design">Graphic Design</option>
                    <option value="Digital Marketing">Digital Marketing</option>
                    <option value="Content Writing">Content Writing</option>
                    <option value="Photography">Photography</option>
                    <option value="Programming">Programming</option>
                    <option value="Business Services">Business Services</option>
                    <option value="Digital Products">Digital Products</option>
                    <option value="Physical Products">Physical Products</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <button onclick="filterProducts()" 
                    class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                Apply Filters
            </button>
        </div>
    </div>

    <!-- Products Grid -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <div id="loadingSpinner" class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto"></div>
            <p class="mt-2 text-gray-600">Loading products...</p>
        </div>
        
        <div id="productsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Products will be loaded here -->
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p>&copy; 2024 Moi University Ajira Club. All rights reserved.</p>
        </div>
    </footer>

    <!-- Firebase SDK Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDmvTc1Vpd4ndDX1zpyq67MVuFFNMkt8YA",
            authDomain: "ajira-club.firebaseapp.com",
            projectId: "ajira-club",
            storageBucket: "ajira-club.firebasestorage.app",
            messagingSenderId: "1089850645017",
            appId: "1:1089850645017:web:0bd42110eb091c0afb6888"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const productsContainer = document.getElementById('productsContainer');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const searchInput = document.getElementById('searchInput');
        const typeFilter = document.getElementById('typeFilter');
        const categoryFilter = document.getElementById('categoryFilter');

        let allProducts = [];
        let currentUserId = null;

        // Sign in anonymously to access the public data
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    const userCredential = await signInAnonymously(auth);
                    currentUserId = userCredential.user.uid;
                } catch (error) {
                    console.error("Anonymous sign-in failed:", error);
                }
            } else {
                currentUserId = user.uid;
            }
            fetchProducts();
        });

        const fetchProducts = () => {
            const productsCollectionRef = collection(db, `/artifacts/ajira-club/public/data/products`);
            
            onSnapshot(productsCollectionRef, (querySnapshot) => {
                const products = [];
                querySnapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                allProducts = products;
                displayProducts(allProducts);
                loadingSpinner.classList.add('hidden');
            }, (error) => {
                console.error("Error fetching products:", error);
                loadingSpinner.innerHTML = '<p class="text-red-500">Failed to load products. Please check your internet connection and Firebase rules.</p>';
            });
        };

        const displayProducts = (productsToDisplay) => {
            productsContainer.innerHTML = ''; // Clear the container
            if (productsToDisplay.length === 0) {
                productsContainer.innerHTML = '<p class="text-center text-gray-500">No products found matching your criteria.</p>';
                return;
            }
            productsToDisplay.forEach(product => {
                const isOwner = currentUserId && product.userId === currentUserId;
                const deleteButton = isOwner ? 
                    `<button onclick="deleteProduct('${product.id}')" class="absolute top-2 right-2 p-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>` : '';

                // FIX: Check for 'contactPhone' field (used in the posting form) 
                // and fall back to older keys if needed for existing data.
                const contactValue = product.contactPhone || product.contactInfo || product.contactEmail;
                // FIX: Use 'tel:' link for phone numbers
                const contactLink = contactValue ? `tel:${contactValue}` : '#'; 

                const productCard = `
                    <div class="bg-white p-6 rounded-xl shadow-md transform hover:scale-105 transition duration-300 relative">
                        ${deleteButton}
                        <h2 class="text-xl font-bold text-green-800">${product.title}</h2>
                        <span class="inline-block px-3 py-1 mt-2 text-sm font-semibold rounded-full
                                     ${product.type === 'product' ? 'bg-blue-200 text-blue-800' : 'bg-purple-200 text-purple-800'}">
                            ${product.type}
                        </span>
                        <p class="text-gray-600 mt-2">${product.description}</p>
                        ${product.imageUrl ? `<img src="${product.imageUrl}" alt="${product.title}" class="mt-4 rounded-md">` : ''}
                        <p class="text-gray-800 font-semibold mt-2">
                            Category: <span class="text-green-600">${product.category}</span>
                        </p>
                        <p class="text-gray-800 font-semibold mt-1">
                            Contact: <a href="${contactLink}" class="text-green-600 underline">${contactValue || 'N/A'}</a>
                        </p>
                        <p class="text-gray-800 font-semibold mt-1">
                            Price: <span class="text-green-600">${product.price}</span>
                        </p>
                    </div>
                `;
                productsContainer.innerHTML += productCard;
            });
        };
        
        window.deleteProduct = async (productId) => {
            // FIX: Using a custom modal instead of window.confirm
            const confirmationModal = document.createElement('div');
            confirmationModal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50';
            confirmationModal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto">
                    <h3 class="text-lg font-bold mb-4">Confirm Deletion</h3>
                    <p>Are you sure you want to delete this product?</p>
                    <div class="mt-4 flex justify-end space-x-3">
                        <button id="cancelDelete" class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400">Cancel</button>
                        <button id="confirmDelete" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Delete</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmationModal);

            return new Promise((resolve) => {
                document.getElementById('cancelDelete').onclick = () => {
                    document.body.removeChild(confirmationModal);
                    resolve(false);
                };
                document.getElementById('confirmDelete').onclick = () => {
                    document.body.removeChild(confirmationModal);
                    resolve(true);
                };
            }).then(async confirmed => {
                if (!confirmed) return;

                try {
                    const appId = "ajira-club";
                    const docRef = doc(db, `/artifacts/${appId}/public/data/products`, productId);
                    await deleteDoc(docRef);
                    console.log("Product successfully deleted!");
                } catch (error) {
                    console.error("Error removing document: ", error);
                    // Provide feedback to the user on failure
                    const errorBox = document.createElement('div');
                    errorBox.className = 'fixed bottom-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl transition-opacity duration-300';
                    errorBox.textContent = 'Failed to delete product. Check console for details.';
                    document.body.appendChild(errorBox);
                    setTimeout(() => document.body.removeChild(errorBox), 3000);
                }
            });
        };

        window.filterProducts = () => {
            const selectedType = typeFilter.value;
            const selectedCategory = categoryFilter.value;
            const searchQuery = searchInput.value.toLowerCase();

            const filteredProducts = allProducts.filter(product => {
                const matchesType = !selectedType || product.type === selectedType;
                const matchesCategory = !selectedCategory || product.category === selectedCategory;
                
                // Also check against the new contact field (contactPhone)
                const productContact = (product.contactPhone || '').toLowerCase(); 

                const matchesSearch = !searchQuery || 
                                     product.title.toLowerCase().includes(searchQuery) || 
                                     product.description.toLowerCase().includes(searchQuery) ||
                                     productContact.includes(searchQuery);

                return matchesType && matchesCategory && matchesSearch;
            });
            displayProducts(filteredProducts);
        };
        
        window.searchProducts = () => {
            filterProducts();
        }
    </script>
</body>
</html>
